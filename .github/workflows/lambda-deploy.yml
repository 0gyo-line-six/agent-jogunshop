name: Deploy to AWS Lambda

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      AWS_REGION: ap-northeast-2
      ECR_REPOSITORY: agent-jogunshop
      LAMBDA_FUNCTION_NAME: agent-jogunshop

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: aws-account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account-id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "Account ID: $ACCOUNT_ID"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create ECR repository if needed
        run: |
          aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} 2>/dev/null || \
          aws ecr create-repository --repository-name ${{ env.ECR_REPOSITORY }}

      - name: Clean up ECR and Docker cache (README ë°©ì‹)
        run: |
          echo "ğŸ§¹ ê¸°ì¡´ ë¹Œë“œ ì™„ì „ ì •ë¦¬ ì¤‘ (README ìµœì í™” ë°©ì‹)..."
          
          # ECRì˜ ëª¨ë“  ì´ë¯¸ì§€ ì‚­ì œ (README ë°©ì‹)
          echo "ğŸ—‘ï¸ ECR ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          aws ecr list-images --repository-name ${{ env.ECR_REPOSITORY }} --query 'imageIds[*]' --output json 2>/dev/null | \
          jq -r '.[] | "imageDigest=" + .imageDigest' | \
          xargs -I {} aws ecr batch-delete-image --repository-name ${{ env.ECR_REPOSITORY }} --image-ids {} 2>/dev/null || true
          
          # ë¡œì»¬ ì´ë¯¸ì§€ì™€ ìºì‹œ ì™„ì „ ì •ë¦¬ (README ë°©ì‹)
          echo "ğŸ’¾ ë¡œì»¬ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          docker rmi ${{ env.ECR_REPOSITORY }}:latest 2>/dev/null || true
          docker rmi ${{ steps.aws-account.outputs.account-id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:* 2>/dev/null || true
          docker system prune -af
          docker builder prune -af
          
          echo "âœ… ì™„ì „ ì •ë¦¬ ì™„ë£Œ (ECR + ë¡œì»¬)"

      - name: Build Docker image (README ìµœì í™” ë°©ì‹)
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: v$(date +%Y%m%d-%H%M%S)
        run: |
          echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘ (README ë°©ì‹)..."
          
          # READMEì˜ ë‚ ì§œ ê¸°ë°˜ ê³ ìœ  íƒœê·¸ ìƒì„±
          TIMESTAMP_TAG="v$(date +%Y%m%d-%H%M%S)"
          echo "ğŸ“… íƒ€ì„ìŠ¤íƒ¬í”„ íƒœê·¸: $TIMESTAMP_TAG"
          
          # buildx ë¹„í™œì„±í™”ë¡œ ë‹¨ì¼ ì•„í‚¤í…ì²˜ ì´ë¯¸ì§€ ê°•ì œ ìƒì„± (README ë°©ì‹)
          export DOCKER_BUILDKIT=0
          echo "ğŸ”§ DOCKER_BUILDKIT=0 ì„¤ì • ì™„ë£Œ"
          
          # ìºì‹œ ì—†ì´ ê¹¨ë—í•œ ë¹Œë“œ (README ë°©ì‹)
          docker build --pull --no-cache -t ${{ env.ECR_REPOSITORY }}:latest .
          
          # ë¹Œë“œëœ ì´ë¯¸ì§€ ì•„í‚¤í…ì²˜ í™•ì¸ (README ë°©ì‹)
          ARCH=$(docker image inspect ${{ env.ECR_REPOSITORY }}:latest --format '{{.Architecture}}')
          echo "ë¹Œë“œëœ ì´ë¯¸ì§€ ì•„í‚¤í…ì²˜: $ARCH"
          
          # ECR íƒœê·¸ ì ìš© (README ë°©ì‹ì˜ ê³ ìœ  íƒœê·¸)
          docker tag ${{ env.ECR_REPOSITORY }}:latest $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$TIMESTAMP_TAG
          docker tag ${{ env.ECR_REPOSITORY }}:latest $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest
          
          echo "image-tag=$TIMESTAMP_TAG" >> $GITHUB_OUTPUT
          echo "full-image-uri=$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$TIMESTAMP_TAG" >> $GITHUB_OUTPUT
          
          echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ (README ë°©ì‹)"
        id: build-image

      - name: Push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.build-image.outputs.image-tag }}
        run: |
          echo "ğŸ“¤ ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘..."
          
          # ê³ ìœ í•œ íƒœê·¸ë¡œ í‘¸ì‹œ (Image Manifest ì¶©ëŒ ë°©ì§€)
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
          
          # latest íƒœê·¸ë„ í‘¸ì‹œ
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest
          
          echo "âœ… ECR í‘¸ì‹œ ì™„ë£Œ"

      - name: Create Lambda function if not exists
        env:
          FULL_IMAGE_URI: ${{ steps.build-image.outputs.full-image-uri }}
        run: |
          echo "ğŸ” Lambda í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸..."
          
          if aws lambda get-function --function-name ${{ env.LAMBDA_FUNCTION_NAME }} 2>/dev/null; then
            echo "âœ… Lambda í•¨ìˆ˜ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          else
            echo "ğŸš€ ìƒˆ Lambda í•¨ìˆ˜ ìƒì„± ì¤‘..."
            aws lambda create-function \
              --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
              --package-type Image \
              --code ImageUri=$FULL_IMAGE_URI \
              --role arn:aws:iam::${{ steps.aws-account.outputs.account-id }}:role/lambda-execution-role \
              --timeout 900 \
              --memory-size 1024 \
              --architectures arm64 \
              --environment Variables='{
                "DSPY_CACHE_DIR": "/tmp/dspy_cache"
              }'
            echo "âœ… Lambda í•¨ìˆ˜ ìƒì„± ì™„ë£Œ"
          fi

      - name: Update Lambda function code
        env:
          FULL_IMAGE_URI: ${{ steps.build-image.outputs.full-image-uri }}
        run: |
          echo "ğŸ”„ Lambda í•¨ìˆ˜ ì½”ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."
          echo "Image URI: $FULL_IMAGE_URI"
          
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --image-uri $FULL_IMAGE_URI
          
          echo "âœ… Lambda í•¨ìˆ˜ ì½”ë“œ ì—…ë°ì´íŠ¸ ì‹œì‘"

      - name: Wait for update to complete and verify
        run: |
          echo "â³ Lambda í•¨ìˆ˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
          
          aws lambda wait function-updated-v2 --function-name ${{ env.LAMBDA_FUNCTION_NAME }}
          
          echo "ğŸ” Lambda í•¨ìˆ˜ ìƒíƒœ í™•ì¸..."
          FUNC_STATE=$(aws lambda get-function --function-name ${{ env.LAMBDA_FUNCTION_NAME }} --query 'Configuration.State' --output text)
          echo "í•¨ìˆ˜ ìƒíƒœ: $FUNC_STATE"
          
          if [ "$FUNC_STATE" = "Active" ]; then
            echo "âœ… Lambda í•¨ìˆ˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ ë° í™œì„±í™”ë¨"
            
            # í•¨ìˆ˜ ì •ë³´ ì¶œë ¥
            aws lambda get-function --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
              --query 'Configuration.{
                FunctionName:FunctionName,
                Runtime:Runtime,
                MemorySize:MemorySize,
                Timeout:Timeout,
                LastModified:LastModified,
                CodeSha256:CodeSha256
              }' --output table
          else
            echo "âŒ Lambda í•¨ìˆ˜ê°€ ë¹„í™œì„± ìƒíƒœì…ë‹ˆë‹¤: $FUNC_STATE"
            exit 1
          fi

      - name: Test Lambda function
        run: |
          echo "ğŸ§ª Lambda í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì¤‘..."
          
          # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ í˜ì´ë¡œë“œë¡œ í•¨ìˆ˜ í˜¸ì¶œ
          aws lambda invoke \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --payload '{"test": true, "message": "GitHub Actions ë°°í¬ í…ŒìŠ¤íŠ¸"}' \
            --cli-binary-format raw-in-base64-out \
            response.json
          
          # ì‘ë‹µ í™•ì¸
          if [ -f response.json ]; then
            echo "ğŸ“„ Lambda ì‘ë‹µ:"
            cat response.json
            echo ""
            echo "âœ… Lambda í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
          else
            echo "âŒ Lambda í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
            exit 1
          fi

      - name: Deployment summary
        env:
          IMAGE_TAG: ${{ steps.build-image.outputs.image-tag }}
          FULL_IMAGE_URI: ${{ steps.build-image.outputs.full-image-uri }}
        run: |
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ ìš”ì•½"
          echo "=================="
          echo "ğŸ“¦ ì´ë¯¸ì§€ íƒœê·¸: $IMAGE_TAG"
          echo "ğŸ”— ì´ë¯¸ì§€ URI: $FULL_IMAGE_URI"
          echo "âš¡ Lambda í•¨ìˆ˜: ${{ env.LAMBDA_FUNCTION_NAME }}"
          echo "ğŸŒ ë¦¬ì „: ${{ env.AWS_REGION }}"
          echo "ğŸ•’ ë°°í¬ ì‹œê°„: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"